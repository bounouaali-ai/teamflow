<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TeamFlow â€” Ø¥Ø¯Ø§Ø±Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--white:#ffffff}
  html,body{height:100%;margin:0;font-family:Tahoma, Arial, "Noto Naskh Arabic", sans-serif;background:#071027;color:var(--muted)}
  .container{max-width:1100px;margin:28px auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#075985,#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  h1{color:var(--white);margin:0;font-size:18px}
  .userBox{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;display:flex;gap:10px;align-items:center}
  .userName{font-weight:600;color:#e6f7fb}
  .roleBadge{font-size:12px;color:var(--bg);background:var(--accent);padding:4px 8px;border-radius:8px}
  main{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .panel{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 4px 18px rgba(2,6,23,0.6)}
  .panel h2{margin:0 0 8px;color:var(--white)}
  .suggestion-list{display:flex;flex-direction:column;gap:10px}
  .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
  .card h3{margin:0;color:#fff;font-size:15px}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}
  .right{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:var(--bg);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--white);border:1px solid rgba(255,255,255,0.04)}
  .small{padding:6px 8px;font-size:13px}
  #addSuggestionBtn{width:100%;margin-top:10px}
  /* modal */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:50}
  .modalCard{width:420px;background:#071a2b;padding:16px;border-radius:10px}
  .field{display:flex;flex-direction:column;margin-bottom:10px}
  label{color:var(--muted);font-size:13px;margin-bottom:6px}
  input[type="datetime-local"],input[type="text"],textarea,select{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white);outline:none}
  textarea{min-height:80px;resize:vertical}
  .row{display:flex;gap:8px}
  /* notifications */
  #notificationContainer{position:fixed;right:18px;top:18px;z-index:80;display:flex;flex-direction:column;gap:10px}
  .notification{background:#072b34;color:#e6f7fb;padding:10px 12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
  .notification.error{background:#4b0f0f}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  @media(max-width:900px){main{grid-template-columns:1fr} .modalCard{width:92%}}
</style>
</head>
<body>
<div id="notificationContainer"></div>

<div class="container">
  <header>
    <div class="brand">
      <div class="logo">TF</div>
      <div>
        <h1>TeamFlow â€” ÙØ±ÙŠÙ‚ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… Ø§Ù„Ø°ÙƒÙŠ (Ø¬Ø§Ù…Ø¹Ø© ØºØ±Ø¯Ø§ÙŠØ©)</h1>
        <div style="color:var(--muted);font-size:13px">Ù†Ø¸Ø§Ù… Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆØ§Ø¹ÙŠØ¯ØŒ ØªØµÙˆÙŠØªØŒ ÙˆØªÙØ§Ø¹Ù„ Ø¯Ø§Ø®Ù„ÙŠ</div>
      </div>
    </div>

    <div class="userBox">
      <div>
        <div id="userName" class="userName">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</div>
        <div style="font-size:12px;color:var(--muted)" id="userEmail"></div>
      </div>
      <div style="width:10px"></div>
      <div id="userRole" class="roleBadge">â€”</div>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</h2>
      <div id="matchSuggestions" class="suggestion-list">
        <!-- Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ØªÙØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
      </div>

      <button id="addSuggestionBtn" class="btn" title="Ø¥Ø¶Ø§ÙØ© Ø§Ù‚ØªØ±Ø§Ø­">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ø¨Ø§Ø±Ø§Ø©</button>

      <footer>
        <small>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ…Ù„ÙƒÙˆØ§ Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø³Ø³ÙŠ @univ-ghardaia.edu.dz</small>
      </footer>
    </section>

    <aside class="panel">
      <h2>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h2>

      <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px">
        <button id="attendMatchBtn" class="btn ghost small">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±ÙŠ Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</button>
        <button id="refreshBtn" class="btn small">ğŸ” ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</button>
        <div style="height:6px"></div>
        <div style="color:var(--muted);font-size:13px">Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ API (Ù…Ø®ÙÙŠ Ø¶Ù…Ù† Ø§Ù„ÙƒÙˆØ¯)</div>
      </div>
    </aside>
  </main>
</div>

<!-- Modal Ø¥Ø¶Ø§ÙØ© Ø§Ù‚ØªØ±Ø§Ø­ -->
<div id="suggestionModal" class="modal" style="display:none">
  <div class="modalCard">
    <h3 style="color:var(--white);margin:0 0 8px">Ø¥Ø¶Ø§ÙØ© Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ø¨Ø§Ø±Ø§Ø©</h3>

    <div class="field">
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</label>
      <input id="suggestionDate" type="datetime-local" />
    </div>

    <div class="field">
      <label>Ø§Ù„Ù…ÙƒØ§Ù†</label>
      <input id="suggestionLocation" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù„Ø¹Ø¨ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©" />
    </div>

    <div class="field">
      <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="suggestionNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="cancelSuggestionBtn" class="btn ghost">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="saveSuggestionBtn" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­</button>
    </div>
  </div>
</div>

<script>
/* ========== Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Web App Ø§Ù„Ø°ÙŠ Ù†Ø´Ø±ØªÙ‡ ========== */
const WEB_APP_URL = "https://script.google.com/a/macros/univ-ghardaia.edu.dz/s/AKfycbyGrYW3zkut7a79G903DMXKPJ3LBZNI74t8W2lY2YSz0_1r25Fl7STOmuMKLkZrcZBUbQ/exec";

/* Ø­Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ */
let app = { currentUser: null };

/* Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
function showNotification(msg, type='ok'){
  const c = document.getElementById('notificationContainer');
  const n = document.createElement('div');
  n.className = 'notification' + (type==='error' ? ' error' : '');
  n.textContent = msg;
  c.appendChild(n);
  setTimeout(()=> n.remove(), 3500);
}

/* Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API */
async function callAPI(action, params = {}) {
  const url = new URL(WEB_APP_URL);
  url.searchParams.set('action', action);
  Object.entries(params).forEach(([k,v]) => { if (v !== undefined && v !== null) url.searchParams.set(k, v); });

  try {
    const r = await fetch(url.toString(), { method: 'GET', credentials: 'include' });
    if (!r.ok) throw new Error('Network response not ok: ' + r.status);
    const data = await r.json();
    return data;
  } catch (err) {
    console.error('API error', err);
    showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
    return null;
  }
}

/* Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ */
async function loadCurrentUser(){
  const res = await callAPI('getUser');
  if (!res) return;
  if (!res.ok) {
    showNotification(res.error || 'ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
    return;
  }
  app.currentUser = res.user;
  document.getElementById('userName').textContent = res.user.name || res.user.email;
  document.getElementById('userEmail').textContent = res.user.email;
  document.getElementById('userRole').textContent = (res.user.role || 'PLAYER');
  // Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¥Ù† ÙƒØ§Ù† ORGANIZER
  if(res.user.role === 'ORGANIZER') document.getElementById('userRole').style.display = 'inline-block';
  loadMatchSuggestions();
}

/* Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª */
async function loadMatchSuggestions(){
  const res = await callAPI('getSuggestions');
  const container = document.getElementById('matchSuggestions');
  container.innerHTML = '';
  if(!res || !res.suggestions || res.suggestions.length === 0){
    container.innerHTML = '<div class="card"><div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div></div>';
    return;
  }

  // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ createdAt (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹) Ø¥Ù† ÙˆÙØ¬Ø¯ Ø­Ù‚Ù„ createdAt
  const list = res.suggestions.slice().sort((a,b)=>{
    const ta = new Date(a.matchDateISO||a.createdAt||0).getTime();
    const tb = new Date(b.matchDateISO||b.createdAt||0).getTime();
    return ta - tb;
  });

  list.forEach(s=>{
    const voters = s.voters ? (s.voters.split(',').filter(Boolean)) : [];
    const voted = voters.includes(app.currentUser.email);
    const dateStr = s.matchDateISO ? new Date(s.matchDateISO).toLocaleString('ar-DZ') : 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div style="max-width:70%">
          <h3>${s.location || 'Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù'}</h3>
          <div class="meta">${dateStr} â€¢ ${s.notes ? s.notes : ''}</div>
          <div class="meta">Ù…Ù‚ØªØ±Ø­ Ù…Ù†: ${s.proposerId}</div>
        </div>
        <div class="right">
          <button class="btn small" data-id="${s.id}" style="background:${voted? '#28a745' : ''}">${voted? 'âœ” Ù…ØµÙˆÙ‘Øª' : 'ğŸ‘ ØµÙˆØª'} (${s.votesCount||0})</button>
        </div>
      </div>
    `;
    // Ø±Ø§Ø¨Ø· Ø§Ù„ØªØµÙˆÙŠØª
    el.querySelector('button').addEventListener('click', async (ev)=>{
      const btn = ev.currentTarget;
      btn.disabled = true;
      const sid = btn.getAttribute('data-id');
      const r = await callAPI('voteSuggestion', { id: sid });
      if (r && r.ok) {
        await loadMatchSuggestions();
        showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙˆÙŠØª');
      } else {
        showNotification('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª', 'error');
      }
      btn.disabled = false;
    });

    container.appendChild(el);
  });
}

/* ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ */
document.getElementById('addSuggestionBtn').addEventListener('click', ()=> {
  document.getElementById('suggestionModal').style.display = 'flex';
});
document.getElementById('cancelSuggestionBtn').addEventListener('click', ()=> {
  document.getElementById('suggestionModal').style.display = 'none';
});

/* Ø­ÙØ¸ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ */
document.getElementById('saveSuggestionBtn').addEventListener('click', async ()=>{
  const date = document.getElementById('suggestionDate').value;
  const location = document.getElementById('suggestionLocation').value.trim();
  const notes = document.getElementById('suggestionNotes').value.trim();
  if(!date || !location) return showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…ÙƒØ§Ù†', 'error');

  const r = await callAPI('suggestMatch', { dateISO: new Date(date).toISOString(), location, notes });
  if (r && r.ok) {
    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­');
    document.getElementById('suggestionModal').style.display = 'none';
    document.getElementById('suggestionDate').value = '';
    document.getElementById('suggestionLocation').value = '';
    document.getElementById('suggestionNotes').value = '';
    await loadMatchSuggestions();
  } else {
    showNotification('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­', 'error');
  }
});

/* Ø²Ø± Ø§Ù„Ø­Ø¶ÙˆØ± (Ù…Ø¤Ù‚Øª â€” Ø³ÙŠØ­ØªØ§Ø¬ endpoint ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„) */
document.getElementById('attendMatchBtn').addEventListener('click', async ()=>{
  showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (Ù…Ø¤Ù‚Øª) â€” Ø³ÙŠØªÙ… Ø±Ø¨Ø·Ù‡ Ø¨Ø®Ø§Ø¯Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹');
});

/* Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« */
document.getElementById('refreshBtn').addEventListener('click', loadMatchSuggestions);

/* Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
window.addEventListener('DOMContentLoaded', async ()=>{
  showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...', 'ok');
  await loadCurrentUser();
});
</script>
</body>
</html>
